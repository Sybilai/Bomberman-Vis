<html>
<head>
  <script src="draw.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
background:
radial-gradient(black 15%, transparent 16%) 0 0,
radial-gradient(black 15%, transparent 16%) 8px 8px,
radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px,
radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;
background-color:#282828;
background-size:16px 16px;
    }
    canvas {
      display: block;
      margin: 0 auto;
    }
    .error {
      display: none;
      margin: 0 auto;
      margin-top: 20px;
      width: 350px;

      background: rgba(250, 0, 0, 0.4);
      border: 4px solid rgba(180, 0, 0, 0.8);

      color: white;
      font-size: 30px;
      text-align: center;
      font-weight: bold;
      font-family: sans-serif;
      line-height: 1.5;
      font-size: 18px;
      padding: 15px 10px;
    }
    .error.active {
      display: block;
    }
  </style>
</head>

<body id="body">
  <div class="error">Connection can't be created. This page will refresh.</div>

<script>
  var ws = new WebSocket('ws://sybilai.com:62421/');
  var Entities = {};

  Draw.init();

  ws.onopen = function(res) {
    console.log(res);
  };

  ws.onclose = function() {
    document.getElementById("body").removeChild(document.getElementsByTagName("canvas")[0]);
    document.getElementsByClassName("error")[0].setAttribute("class","error active");
    setTimeout( function() {
      location.reload();
    }, 5000);
  };

  ws.onmessage = function(res) {
    messages = res.data;
    messages = messages.split('\n');
    messages.pop();

    while (messages.length) {
      var v = messages.shift();

      try {
        v = JSON.parse(v);
      } catch (e) {
        continue;
      }

      switch (v.event) {
        case 'game':
          Draw.resize(v.game_rules.sizeN, v.game_rules.sizeM);
          Draw.matrices = v.game_state;
          for (var i = 0, il = Draw.matrices.length; i < il; ++i) {
            for (var j = 0, jl = Draw.matrices[i].length; j < jl; ++j) {
              for (var c = 0, cl = Draw.matrices[i][j].content.length; c < cl; ++c) {
                Entities[ Draw.matrices[i][j].content[c].object_id ] = Draw.matrices[i][j].content[c];
              }
            }
          }
          break;

        case 'new_entity':
          if (Draw.matrices === undefined) return;
          Draw.matrices[v.x][v.y].content.push(v.data);
          Entities[v.data.object_id] = v.data;
          break;

        case 'destroy_entity':
          if (Draw.matrices === undefined) return;
          var a = Entities[v.object_id];
          Draw.destroy(a);
          delete Entities[v.object_id];
          break;

        case 'move_entity':
          if (Draw.matrices === undefined) return;
          Draw.destroy( Entities[v.object_id] );
          Entities[v.object_id].pos = {x: v.x, y: v.y};
          Draw.matrices[v.x][v.y].content.push( Entities[v.object_id] );
          break;

        case 'update_entity':
          if (Draw.matrices === undefined) return;
          Entities[v.object_id] = v.data;
          break;
      }

      Draw.update();
    }

  }
</script>

</body>
</html>
